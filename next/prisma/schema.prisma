// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url  	    = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  // uncomment next line if you use Prisma <5.10
  // directUrl = env("DATABASE_URL_UNPOOLED")
}

model BeachGoodRating {
  id          String   @id @default(uuid())
  date        String   // YYYY-MM-DD format
  beachId     String
  region      String
  score       Int      // 4 or 5
  conditions  Json     // Store the conditions that made it good
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([date, region])
  @@index([beachId, date])
}

model AdRequest {
  id                   String    @id
  category             String    // Store the ad category
  companyName          String
  contactEmail         String
  imageUrl             String?
  linkUrl             String
  title               String?
  region              String    // Required field for regional targeting
  startDate           DateTime  // Changed to DateTime
  endDate             DateTime  // Changed to DateTime
  status              String   
  rejectionReason     String?
  categoryData        Json?     // Store category-specific fields
  yearlyPrice         Float     // Yearly price for the ad
  googleAdsContribution Float   // Monthly contribution to Google Ads budget
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  userId              String?
  lemonSubscriptionId String?
  googleAdsCampaignId String?
   payfastSubscriptionId String?
   variantId           String?
  
  @@index([payfastSubscriptionId])
  
  user User? @relation(fields: [userId], references: [id])

  @@index([region])
  @@index([category])
  @@index([status])
}

// Core User Model
model User {
  id            String      @id @default(cuid())
  name          String
  bio           String?
  email         String      @unique
  emailVerified DateTime?
  image         String?
  password      String?
  savedFilters  Json?  
  skillLevel    SkillLevel?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lemonCustomerId String?
  lemonSubscriptionId String?
  trialStartDate    DateTime?
  trialEndDate      DateTime?
  hasActiveTrial    Boolean     @default(false)

  // Auth Relations
  accounts      Account[]
  sessions      Session[]

  // Membership
  membership    Membership?

  // Relations as Host/Guide
  bnbListings   BnbListing[]    // As a BnB host
  surfSafaris   SurfSafariListing[]    // As a safari guide
  
  // Relations as Customer
  bnbBookings   BnbBooking[]    // As a surfer booking BnB
  safariBookings SafariBooking[] // As a surfer booking safari
  reviews       Review[]         // Reviews left by user

  // User's Board Model
  boards        Board[]

  adRequests    AdRequest[]

  stories       Story[]

  events        Event[]

  filters       UserFilters?

  favorites     UserFavorite[]

  @@index([email])
  @@index([skillLevel])
}

model Event {
  id          String   @id @default(cuid())
  title       String
  description String
  country     String
  region      String
  startTime   DateTime
  link        String?
  createdAt   DateTime @default(now())
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model LogEntry {
  id          String   @id @default(cuid())
  date        DateTime
  surferName  String
  surferEmail String
  beachName   String
  forecast    Json
  surferRating Int
  comments    String
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isPrivate   Boolean @default(false)

  @@index([surferEmail])
  @@index([date])
}

// Safari Booking Model
model SafariBooking {
  id          String    @id @default(cuid())
  safariId    String
  userId      String
  date        DateTime
  bringingBoard Boolean  @default(false)
  requiresRental Boolean @default(false)
  skillLevel  SkillLevel
  status      BookingStatus @default(PENDING)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  boardId     String?
  board       Board?    @relation(fields: [boardId], references: [id])

  safari      SurfSafariListing @relation(fields: [safariId], references: [id], onDelete: Restrict)
  user        User      @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([safariId])
  @@index([userId])
  @@index([date])
  @@index([status])
  @@index([boardId])
}

model BnbBooking {
  id          String    @id @default(cuid())
  listingId   String
  userId      String
  startDate   DateTime
  endDate     DateTime
  boardId     String?   // User's own board if they bring one
  rentBoardId String?   // Host's board if they want to rent one
  notes       String?
  status      BookingStatus @default(PENDING)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  listing     BnbListing @relation(fields: [listingId], references: [id])
  user        User      @relation(fields: [userId], references: [id])
  board       Board?    @relation("UserOwnBoard", fields: [boardId], references: [id])
  rentBoard   Board?    @relation("RentalBoard", fields: [rentBoardId], references: [id])

  @@index([listingId])
  @@index([userId])
  @@index([status])
}


// Enums
enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  PRO
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum SleepingType {
  COUCH
  PRIVATE_ROOM
  SHARED_ROOM
  AIR_MATTRESS
  MATTRESS
  BUNK
}


// BnbListing Model
model BnbListing {
  id                  String   @id @default(cuid())
  hostId              String
  title               String
  description         String
  location            String
  profileImage        String?
  images              String
  
  // Accommodation Details
  sleepingArrangement SleepingType
  breakfastOptions    String
  price               Float?
  isFree              Boolean  @default(false)
  
  // Transport
  hasVehicleTransport Boolean   @default(false)
  canTransportLongboard Boolean @default(false)
  canTransportShortboard Boolean @default(false)
  
  // Metadata
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  host                User     @relation(fields: [hostId], references: [id], onDelete: Cascade)
  beaches             BeachBnbConnection[]
  reviews             Review[]
  bookings            BnbBooking[]

  @@index([hostId])
  @@index([isActive])
}

// Surf Safari Model
model SurfSafariListing {
  id          String    @id @default(cuid())
  guideId     String
  title       String
  description String
  profileImage String?
  
  // Pricing
  price       Float?
  isFree      Boolean   @default(false)
  
  // Transport
  hasVehicleTransport Boolean   @default(false)
  canTransportLongboard Boolean @default(false)
  canTransportShortboard Boolean @default(false)
  
  // Metadata
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  guide        User      @relation(fields: [guideId], references: [id], onDelete: Cascade)
  beaches      BeachSafariConnection[]
  bookings     SafariBooking[]
  reviews      Review[]

  @@index([guideId])
  @@index([isActive])
}


model BeachSafariConnection {
  id          String    @id @default(cuid())
  beachId     String
  safariId    String
  distance    Float?    // Distance in km
  safari      SurfSafariListing  @relation(fields: [safariId], references: [id])

  @@unique([beachId, safariId])
  @@index([safariId])
  @@index([beachId])
}

model BeachBnbConnection {
  id          String     @id @default(cuid())
  beachId     String
  listingId   String
  distance    Float?     // Distance in km
  
  listing     BnbListing @relation(fields: [listingId], references: [id])

  @@unique([beachId, listingId])
  @@index([listingId])
  @@index([beachId])
}

model Review {
  id          String      @id @default(cuid())
  userId      String
  rating      Int
  comment     String?
  createdAt   DateTime    @default(now())
  
  // Optional relations (one of these will be set)
  bnbListingId String?
  safariId     String?
  
  user        User        @relation(fields: [userId], references: [id])
  bnbListing  BnbListing? @relation(fields: [bnbListingId], references: [id])
  safari      SurfSafariListing? @relation(fields: [safariId], references: [id])

  @@index([userId])
}

model Beach {
  id          String    @id
  name        String    @unique
  stories     Story[]
  feedback    Feedback[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Membership {
  id              String    @id @default(cuid())
  userId          String    @unique
  lemonSqueezyId  String?
  variantId       Int?
  checkoutUrl     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id])
}

// User's Board Model
model Board {
  id          String    @id @default(cuid())
  userId      String
  name        String    // E.g., "My Fish", "Summer Longboard"
  type        BoardType // Shortboard, Longboard, etc
  length      String    // "6'0", "7'2", etc
  finSetup    FinType   // Thruster, Twin, Quad, etc
  isForRent   Boolean   @default(false)
  rentPrice   Float?
  
  // Relations
  user        User      @relation(fields: [userId], references: [id])
  safariBookings SafariBooking[]
  userBookings    BnbBooking[] @relation("UserOwnBoard")
  rentalBookings  BnbBooking[] @relation("RentalBoard")

  @@index([userId])
  @@index([isForRent])
}

enum BoardType {
  SHORTBOARD
  LONGBOARD
  FISH
  FUNBOARD
  SUP
  GUN
  MINI_MAL
}

enum FinType {
  THRUSTER
  TWIN
  QUAD
  SINGLE
  FIVE
  OTHER
}

model SurfCondition {
  id            String   @id @default(uuid())
  date          String   // Store as YYYY-MM-DD
  windDirection String
  windSpeed     Float
  swellHeight   Float
  swellDirection String
  swellPeriod   Float
  timestamp     Float    // Regular timestamp, no need for BigInt
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  region        String   @default("Western Cape")

  @@index([region])
  @@index([date])
}

model Feedback {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  date        DateTime
  beachId     String
  beach       Beach    @relation(fields: [beachId], references: [id])
  conditions  Json     // Store conditions as JSON
  improvements String? @db.Text
}

model Story {
  id            String   @id @default(cuid())
  title         String
  details       String   @db.Text
  date          DateTime
  category      String
  link          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  author        User     @relation(fields: [authorId], references: [id])
  authorId      String
  beachName     String?  // For both custom and existing beaches
  beach         Beach?   @relation(fields: [beachId], references: [id])
  beachId       String?  // Optional relation to existing beach
  customBeach   String?  // For custom beach locations

  @@index([authorId])
  @@index([beachId])
}

model UserFilters {
  id        String   @id @default(cuid())
  userEmail String   @unique
  filters   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserFavorite {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  title       String   @db.VarChar(255)
  videoLink   String   @db.VarChar(2048)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}